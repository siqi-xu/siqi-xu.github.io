---
title: "Resolve Hostname to IP"
layout: post
date: 2016-04-13
permalink : /post/resolve-hostname-to-ip
tag:
- NETWORK
blog: true
---


- [Local Resolution](#local-resolution)
  - [The Relationship Between Hosts and OS Cache](#the-relationship-between-hosts-and-os-cache)
- [DNS Resolution](#dns-resolution)
  - [Authoritative](#authoritative)
    - [Example](#example)
  - [Forwarder](#forwarder)
  - [Iterative Queries and Recursive Queries](#iterative-queries-and-recursive-queries)


当我们输入一个url，比如为：http://www.163.com，把URL分割成几个部分：**协议、网络地址、资源路径**。

- 网络地址指示该连接网络上哪一台计算机，可以是域名或者IP地址，可以包括端口号。这里的域名：www.163.com，端口：80
- 协议是从该计算机获取资源的方式，常见的是HTTP、FTP；
- 资源路径指示从服务器上获取哪一项资源。


如果地址不是一个IP地址，通过DNS（域名系统）将该地址解析成IP地址。IP地址对应着网络上一台计算机，DNS服务器本身也有IP，你的网络设置包含DNS服务器的IP。

下面给出解析域名对应IP的过程


## Local Resolution

输入网址后首先会先通过**本地解析**进行域名解析

一条域名的DNS记录会在本地有两种缓存：浏览器缓存和操作系统(OS)缓存。
在浏览器中访问的时候，会优先访问浏览器缓存，如果未命中则访问OS缓存，最后再访问DNS服务器(一般是ISP提供)，然后DNS服务器会递归式的查找域名记录，然后返回。

1. 尝试从浏览器缓存中获取域名对应的IP，如果上次访问过同一个域名的话。操作系统不会限制浏览器保存DNS记录的时间，不同的浏览器会有各自固定的缓存时间
2. 如果浏览器缓存中不存在映射，操作系统会检测OS缓存中查找是否有网址映射，如果有，返回IP，完成域名解析；
3. 如果OS缓存不存在该映射，则查询本地的hosts文件是否存在该域名。如果有，返回IP地址，完成域名解析；同时放入OS缓存中
4. 如果hosts文件和OS缓存都没有，（会请求转发向路由器，会从路由器上查询DNS缓存，如果路由器不存在，）则需要向DNS解析

PS : [hosts 与 OS 缓存的关系](#the-relationship-between-hosts-and-os-cache)


### The Relationship Between Hosts and OS Cache

hosts文件的原理是：在修改hosts文件后，所有OS缓存会被清空;

这是为了防止OS缓存了已经失效的映射，保证OS缓存中的映射关系是和hosts文件中记录的是一致；当查询hosts文件得到IP地址后，会将映射关系加入OS缓存中，加快解析速度。

同时修改hosts文件后，浏览器缓存不会发生变化，所以有时会出现修改了hosts文件，但是无法生效的问题。
如何清除浏览器的DNS缓存，目前似乎还没有什么办法。浏览器上的“清除缓存”功能并不能清除DNS缓存。


## 	DNS Resolution

如果本地解析失败，则需要进行 **DNS解析**

1. 首先会找到 ISP 的DNS，我们叫它本地DNS服务器，如果要查询的域名，包含在本地配置区域中，则返回解析结果，完成域名解析，此解析具有[权威性](#authoritative)。
2. 如果从本地DNS服务器中查找不到对应的域名，但ISP已缓存该网址映射关系，则返回IP映射，完成域名解析，此解析不具有权威性  
3. 如果本地DNS服务器确实无法找到IP，则根据本地DNS服务器的设置（是否设置了[转发器](#forwarder)）进行查询：

	- 如果未用转发模式，本地DNS就把请求发至 “根DNS服务器”，“根DNS服务器”收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到顶级域名服务器IP信息后，将会联系负责.net域的这台服务器。这台负责.net域的服务器收到请求后，如果自己无法解析，它就会找一个管理.net域的下一级DNS服务器地址(163.com)的IP给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找163.com域服务器，重复上面的动作，进行查询，直至找到www.163.com主机

	- 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，会找再上一个转发的服务器，直到不再转发，还是不成功最后会查找根DNS，进行未转发模式的方式解析

不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机  

PS:[递归查找和迭代查找](#iterative-queries-and-recursive-queries)



### Authoritative

非权威应答是什么？DNS服务器通过查询其他DNS得到的，可能是缓存下来的，而不是本身配置的 (可以用nslookup测试域名解析的结果)

如果同时存在缓存和本地配置，会**先进行本地配置查找**：

1. 如果找到了就是具有权威性，即认为映射关系一定是正确的，不会再向上层的DNS进行访问
2. 如果不存在，则会是缓存中找，缓存中的映射关系是由上次请求其它DNS服务器得到的，可能已经失效，所以具有非权威性

所以如果我们自己搭建DNS服务器，不要随意新建.或.com或.net等根或顶级域名的区域，否则可能会导致不能访问网站，因为自己搭建的DNS服务器存在这个区域，那就是权威，说明自己的数据都是正确的，没有配置响应的映射说明网络上不存在该域名。当然这是错误的。
所以新建区域名一般是二级域名

其实如果没有自己配置DNS服务器，那么**权威性**得到的数据一定是正确的(不然就不能叫权威性)，权威性导致的错误一般是因为自己配置错误


#### Example

现在比如我们需要在内网进行163.com的域名解析，假定这个域名不是网易的，而是我们自己的某个服务器

如果我们设置了.com作为新建区域，虽然能够成功的访问到自己的服务器，不会访问到外部的DNS，但是存在的问题是，如果我们想访问www.baidu.com等会怎么样？会发现不存在该域名。因为DNS服务器认为自己是权威都没有映射，那么其他的DNS也一定没有。

所以新建区域是二级域名比如 163.com，新建主机一般是www，mail，ftp等，构成完全合格的域名 www.163.com 或 ftp.163.com
然后在对应的IP中设置到自己的内网的服务器的IP，这样就可以保证163.com的时候是访问到内网的IP，而www.baidu.com的时候，由于不具有.com的权威性，会从外部的DNS服务器查找IP


### Forwarder

可以根据需要配置条件**转发器**

比如：现在有一个内网1的DNS解析www.123.com 一个内网2的DNS解析是www.456.com，通过某种方式连接两个内网，现在内网1要访问www.456.com。

如果按照一般的途径，由于内网1不存在会直接向根服务器寻找，但是如果配置了转发器的IP是内网2的IP，就不会先向根服务器查询，而是转发到www.456.com。如果内网2的DNS中解析不了，再从根服务器查询

## Iterative Queries and Recursive Queries

1. 递归查询: 
  DNS 查询以各种不同的方式进行解析。有时，客户端也可使用从先前的查询获得的缓存信息就地应答查询。DNS 服务器可使用其自身的资源记录信息缓存来应答查询。DNS 服务器也可代表请求客户端查询或联系其他 DNS 服务器，以便完全解析该名称，并随后将应答返回至客户端。这个过程称为递归。一般DNS解析使用递归查询解析
 
2. 迭代查询: 
  客户端自己也可尝试联系其他的 DNS 服务器来解析名称。当客户端这么做的时候，它会根据来自服务器的参考答案，使用其他的独立查询。该过程称作迭代。

百度知道上有通俗的例子，这里贴上来：

> 你是一台PC主机，你的老师是一台DNS服务器。你有一个数学问题（也就是DNS查询请求）不会，于是咨询你的老师，王老师。他如果会，则直接告诉你；如果不会，那么他有几种方法寻找答案。
> 
>- 递归查询：
>王老师问宋校长（即根域DNS），宋校长他不会，于是去问数学教学组的张教授（即一级DNS）。张教授他没有直接回答，而是去问他下属的一位教几何的李老师（即二级DNS）。正巧，你问的题目李老师他懂，他把答案告诉了张教授。张教授又把答案告诉了宋校长，宋校长又把答案告诉给你的老师，即王老师。最后，王老师把答案告诉你，这样完成了一次递归查询。在这个过程中，你始终等待查询结果。
>
>- 流程：你→王老师、王老师→宋校长、宋校长→张教授、张教授→李老师、李老师→张教授、张教授→宋校长、宋校长→王老师、王老师→你
>
>- 迭代查询：
还是用这个例子来说明。你有一个数学问题（也就是DNS查询请求）不会，于是咨询你的老师，王老师。王老师问他的导师，宋校长（即根域DNS），宋校长他也会，请注意，此处开始与递归查询不一样的是，他不会去帮王老师问其他人，而是对王老师说“你去找张教授（即一级DNS）”，并告诉了张教授的电话号码。王老师打电话找到了张教授问这个问题，张教授也不知道，而是让你去问他的下属，教几何的李老师（即二级DNS）、正巧，你问的题目李老师他懂，他把答案告诉了王老师。这么一来，王老师知道答案就很快告诉了你，这样完成了一次迭代查询。
>
>- 流程：你→王老师、王老师→宋校长、宋校长→王老师、王老师→张教授、张教授→王老师、王老师→李老师、李老师→王老师、王老师→你


